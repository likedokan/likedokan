<!DOCTYPE html>
<html class="scroll-smooth" lang="bn">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>রেফার করুন</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri&amp;display=swap" rel="stylesheet"/>
    <style>
        /* Global styles for the body and font */
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: #e0f7fa; /* Waterdrop light blue background */
            overflow-x: hidden; /* Ensures no horizontal scrollbar due to sidebar */
        }
        /* Styles for profile picture */
        #header-profile-logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #007bff;
            object-fit: cover;
        }

        /* Styles for mobile slide-out menu */
        #mobileSliderMenu {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background-color: #ffffff;
            box-shadow: -8px 0 15px rgba(0, 0, 0, 0.15), inset 4px 0 8px rgba(255, 255, 255, 0.6);
            z-index: 1000;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: 5rem;
            display: flex;
            flex-direction: column;
            border-top-left-radius: 1rem;
            border-bottom-left-radius: 1rem;
            backdrop-filter: saturate(180%) blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        #mobileSliderMenu.active {
            right: 0;
            box-shadow: -12px 0 25px rgba(0, 0, 0, 0.25), inset 4px 0 12px rgba(255, 255, 255, 0.7);
        }

        #sliderMenuContent {
            flex-grow: 1;
            padding: 1.5rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        #sliderMenuContent .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.75rem;
            color: #4338ca;
            font-weight: 600;
            font-size: 1.125rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            box-shadow: 0 0 0 0 transparent;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        #sliderMenuContent .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #4338ca;
            border-top-right-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            transform: scaleY(0);
            transform-origin: center;
            transition: transform 0.3s ease;
            z-index: 1;
        }

        #sliderMenuContent .menu-item:hover::before,
        #sliderMenuContent .menu-item:focus-visible::before {
            transform: scaleY(1);
        }

        #sliderMenuContent .menu-item:hover {
            background-color: #4338ca;
            color: #e0e7ff;
            transform: translateX(6px);
            box-shadow: 0 8px 15px rgba(67, 56, 202, 0.3);
            z-index: 10;
            outline: none;
        }
        #sliderMenuContent .menu-item:focus-visible {
            outline: 2px solid #4338ca;
            outline-offset: 2px;
        }
        /* Overlay backdrop */
        #sliderBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        #sliderBackdrop.active {
            opacity: 1;
            visibility: visible;
        }
        /* New styles for notification dropdown - caret */
        #notificationDropdown::before {
            content: '';
            position: absolute;
            top: -10px;
            right: 18px;
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent white transparent;
            filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.05));
            z-index: 51;
        }
        #notificationDropdown::after {
            content: '';
            position: absolute;
            top: -11px;
            right: 343px;
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent #e2e8f0 transparent;
            z-index: 50;
        }
        @media (max-width: 639px) {
            #notificationDropdown::before,
            #notificationDropdown::after {
                right: 25px;
            }
        }
        /* Additional styles for spinner */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* New styles for login/logout buttons */
        .btn-login {
            background-color: #22c55e;
            color: white;
        }
        .btn-login:hover {
            background-color: #16a34a;
        }
        .btn-login:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4ade80, 0 0 0 4px rgba(34, 197, 94, 0.5);
        }
        .btn-logout {
            background-color: #ef4444;
            color: white;
        }
        .btn-logout:hover {
            background-color: #dc2626;
        }
        .btn-logout:focus {
            outline: none;
            box-shadow: 0 0 0 2px #f87171, 0 0 0 4px rgba(239, 68, 68, 0.5);
        }

        /* Custom styles for form button state */
        .button-loading {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .button-success {
            background-color: #10b981;
        }
        .button-error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-cyan-100 to-blue-200 min-h-screen flex flex-col">
    <!-- Header Template -->
    <template id="header-template">
        <header class="bg-white shadow-xl sticky top-0 z-50 border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <img alt="প্রোফাইল ছবি"
                         class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-indigo-500 shadow-md"
                         loading="lazy"
                         src="https://i.pravatar.cc/300?img=1"
                         id="header-profile-logo"/>
                    <div class="hidden sm:block">
                        <p id="welcomeMessage" class="text-gray-700 font-semibold text-base sm:text-lg leading-tight select-none">আপনার নাম</p>
                        <p class="text-gray-500 text-xs sm:text-sm select-none">আপনার প্রোফাইল</p>
                    </div>
                    <h1 class="text-2 sm:text-3xl font-extrabold text-indigo-600 tracking-wide select-none ml-4 sm:ml-6">
                        <span>রেফার করুন</span>
                    </h1>
                </div>

                <div class="flex items-center space-x-3 sm:space-x-4">
                    <div class="flex items-center space-x-3">
                        <div id="userPointsCard" aria-label="আপনার পয়েন্ট"
                             class="flex items-center bg-indigo-50 text-indigo-700 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90 hidden">
                            <i class="fas fa-coins mr-1 text-yellow-400 text-sm"></i>
                            <span id="userPointsDisplay">0 Points</span>
                        </div>

                        <div id="signInStatusCard" aria-label="সাইন-ইন স্ট্যাটাস"
                             class="flex items-center bg-red-50 text-red-700 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90 hidden cursor-pointer">
                            <i class="fas fa-user-circle mr-1 text-red-500 text-sm"></i>
                            <span id="signInStatusDisplay">লগইন করুন</span>
                        </div>

                        <div id="loadingStatusCard" class="flex items-center bg-gray-100 text-gray-600 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90">
                            <div class="spinner mr-2"></div>
                            <span>লোড হচ্ছে...</span>
                        </div>
                    </div>

                    <button id="notificationButton" aria-label="নোটিফিকেশন"
                            class="relative text-indigo-600 hover:text-indigo-800 transition focus:outline-none">
                        <i class="fas fa-bell text-lg sm:text-xl"></i>
                        <span class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-600 text-white text-xs rounded-full px-1 sm:px-1.5 shadow-lg" id="notificationCountDisplay">0</span>
                    </button>

                    <div id="notificationDropdown" class="absolute top-16 right-4 sm:right-6 md:right-10 bg-white border border-gray-200 rounded-lg shadow-lg w-64 md:w-80 z-50 hidden">
                        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-semibold text-gray-800">নোটিফিকেশনস</h3>
                            <span class="text-xs text-gray-500" id="newNotificationCount">০টি নতুন</span>
                        </div>
                        <div class="py-2 max-h-60 overflow-y-auto" id="notificationList">
                        </div>
                        <div class="px-4 py-3 border-t border-gray-200 text-center">
                            <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">সকল নোটিফিকেশন দেখুন</a>
                        </div>
                    </div>
                    <button id="mobileMenuBtn" aria-label="মেনু"
                            aria-controls="mobileSliderMenu"
                            aria-expanded="false"
                            class="md:hidden text-indigo-600 hover:text-indigo-800 text-xl sm:text-2xl focus:outline-none">
                        <i class="fas fa-bars"></i>
                    </button>

                    <nav aria-label="প্রধান নেভিগেশন"
                         class="hidden md:flex items-center space-x-6 lg:space-x-8 text-indigo-600 font-semibold select-none text-base"
                         role="navigation">
                        <a class="hover:text-indigo-800 transition" href="dashboard.html">ড্যাশবোর্ড</a>
                        <a class="hover:text-indigo-800 transition" href="mytasklist.html">টাস্ক</a>
                        <a class="hover:text-indigo-800 transition" href="leaderboard.html">লিডারবোর্ড</a>
                        <a class="hover:text-indigo-800 transition" href="order.html">অর্ডার</a>
                    </nav>
                </div>
            </div>

            <div id="mobileSliderMenu" role="menu" aria-label="মোবাইল স্লাইডার মেনু">
                <div class="flex items-center space-x-3 p-4 border-b border-gray-200 mb-4">
                    <img alt="স্লাইডার প্রোফাইল ছবি"
                         class="w-16 h-16 rounded-full border-2 border-indigo-500 shadow-md"
                         loading="lazy"
                         src="https://i.pravatar.cc/300?img=1"
                         id="slider-profile-pic"/>
                    <div>
                        <p id="sliderUserName" class="text-gray-700 font-semibold text-lg leading-tight">আপনার নাম</p>
                        <p class="text-gray-500 text-sm">আপনার প্রোফাইল</p>
                    </div>
                </div>
                <div id="sliderMenuContent" role="none">
                    <a class="menu-item" href="dashboard.html" role="menuitem" tabindex="0">ড্যাশবোর্ড</a>
                    <a class="menu-item" href="mytasklist.html" role="menuitem" tabindex="0">আমার টাস্ক</a>
                    <a class="menu-item" href="completedtask.html" role="menuitem" tabindex="0">সম্পূর্ণ করা টাস্ক</a>
                    <a class="menu-item" href="order.html" role="menuitem" tabindex="0">অর্ডার করুন</a>
                    <a class="menu-item" href="reffer.html" role="menuitem" tabindex="0">রেফার করুন</a>
                    <a class="menu-item" href="leaderboard.html" role="menuitem" tabindex="0">লিডারবোর্ড</a>
                </div>
                <div class="p-4 mt-auto border-t border-gray-200">
                    <button id="loginLogoutButton" class="w-full py-2 px-4 rounded-md font-semibold transition-colors duration-200
                                                        focus:outline-none focus:ring-2 focus:ring-offset-2">
                        লগইন করুন
                    </button>
                </div>
            </div>
            <div id="sliderBackdrop" class="hidden" tabindex="-1" aria-hidden="true"></div>
        </header>
    </template>

    <div class="w-full max-w-3xl text-center mb-8 mt-[80px]">
        <img alt="A modern water drop logo with blue gradient and smooth edges" class="mx-auto mb-4" height="150" src="https://storage.googleapis.com/a1aa/image/28bebea7-c775-41c8-49f2-80b564a67bda.jpg" width="150"/>
        <h1 class="text-4xl font-extrabold text-blue-900 mb-2">
            ওয়াটার ড্রপ রেফারেল সিস্টেম
        </h1>
        <!-- UPDATED: Dynamic and attractive message -->
        <p class="text-blue-800 text-lg">
            আপনার রেফারেল কোড/লিংক শেয়ার করে আপনি পান <span id="referrer-points-display" class="font-bold">...</span> পয়েন্ট, এবং আপনার বন্ধু পাবে <span id="referee-points-display" class="font-bold">...</span> পয়েন্ট।
        </p>
    </div>

    <main class="w-full max-w-3xl px-4 sm:px-6 lg:px-8 bg-white bg-opacity-80 rounded-xl shadow-lg p-8">
        <section class="mb-10">
            <h2 class="text-2xl font-semibold text-blue-900 mb-4 flex items-center justify-center">
                <i class="fas fa-user-tag mr-2 text-cyan-600"></i>
                আপনার রেফার কোড ও লিংক
            </h2>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="flex-1">
                    <label class="block text-blue-800 font-medium mb-1" for="referCode">
                        রেফার কোড
                    </label>
                    <input aria-label="Your referral code" class="w-full rounded-md border border-cyan-400 bg-cyan-50 text-blue-900 font-semibold px-4 py-2 cursor-not-allowed select-all" id="referCode" readonly="" type="text" value="লোড হচ্ছে..."/>
                    <button aria-label="Copy referral code" class="mt-2 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-md px-6 py-2 transition-colors flex items-center justify-center" id="copyCodeBtn">
                        <i class="fas fa-copy mr-2"></i>
                        কোড কপি করুন
                    </button>
                </div>
                <div class="flex-1">
                    <label class="block text-blue-800 font-medium mb-1" for="referLink">
                        রেফার লিংক
                    </label>
                    <input aria-label="Your referral link" class="w-full rounded-md border border-cyan-400 bg-cyan-50 text-blue-900 font-semibold px-4 py-2 cursor-not-allowed select-all" id="referLink" readonly="" type="text" value="লোড হচ্ছে..."/>
                    <button aria-label="Copy referral link" class="mt-2 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-md px-6 py-2 transition-colors flex items-center justify-center" id="copyLinkBtn">
                        <i class="fas fa-link mr-2"></i>
                        লিংক কপি করুন
                    </button>
                </div>
            </div>
        </section>
        <section>
            <h2 class="text-2xl font-semibold text-blue-900 mb-4 flex items-center justify-center">
                <i class="fas fa-user-friends mr-2 text-cyan-600"></i>
                রেফারারের রেফার কোড দিন
            </h2>
            <form class="max-w-md mx-auto space-y-4" id="referrerForm" novalidate="">
                <label class="block text-blue-800 font-medium" for="referrerCode">
                    রেফারারের রেফার কোড
                </label>
                <input aria-describedby="referrerHelp" autocomplete="off" class="w-full rounded-md border border-cyan-400 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent" id="referrerCode" name="referrerCode" pattern="^[0-9]{5,20}$" placeholder="আপনার রেফারারের কোড লিখুন" required="" type="text"/>
                <p class="text-sm text-cyan-700" id="referrerHelp">
                    ৫-২০ অক্ষরের সংখ্যা ব্যবহার করুন
                </p>
                <button aria-label="Submit referrer code" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-md px-6 py-2 transition-colors flex items-center justify-center" type="submit" id="submitReferrerBtn">
                    <i class="fas fa-check mr-2"></i>
                    সাবমিট করুন
                </button>
                <p class="text-center mt-2 font-medium" id="formMessage"></p>
            </form>
        </section>
    </main>
    <footer class="w-full max-w-3xl text-center mt-12 mb-6 text-blue-700 text-sm">
        © ২০২৪ ওয়াটার ড্রপ. সর্বস্বত্ব সংরক্ষিত।
    </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getDatabase, ref, get, child, update, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAC4h55aA0Zz--V5ejyndzR5WC_-9rAPio",
            authDomain: "subscribe-bot-6f9b2.firebaseapp.com",
            databaseURL: "https://subscribe-bot-6f9b2-default-rtdb.firebaseio.com",
            projectId: "subscribe-bot-6f9b2",
            storageBucket: "subscribe-bot-6f9b2.firebasestorage.app",
            messagingSenderId: "141787931031",
            appId: "1:141787931031:web:2108a3e930f5ce4fbc64d2",
            measurementId: "G-HSDKCJB14Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Header and Utility Functions (reused and adapted)
        function loadHeaderTemplate() {
            const template = document.getElementById('header-template');
            if (template) {
                const clone = document.importNode(template.content, true);
                document.body.prepend(clone);
            }
        }
        let headerProfileLogo, userPointsCard, userPointsDisplay, signInStatusCard, signInStatusDisplay,
            loadingStatusCard, notificationCountDisplay, newNotificationCount, notificationList,
            welcomeMessage, sliderProfilePic, sliderUserName, loginLogoutButton, notificationButton,
            notificationDropdown, mobileMenuBtn, mobileSliderMenu, sliderBackdrop;

        function getHeaderElements() {
            headerProfileLogo = document.getElementById('header-profile-logo');
            userPointsCard = document.getElementById('userPointsCard');
            userPointsDisplay = document.getElementById('userPointsDisplay');
            signInStatusCard = document.getElementById('signInStatusCard');
            signInStatusDisplay = document.getElementById('signInStatusDisplay');
            loadingStatusCard = document.getElementById('loadingStatusCard');
            notificationCountDisplay = document.getElementById('notificationCountDisplay');
            newNotificationCount = document.getElementById('newNotificationCount');
            notificationList = document.getElementById('notificationList');
            welcomeMessage = document.getElementById('welcomeMessage');
            sliderProfilePic = document.getElementById('slider-profile-pic');
            sliderUserName = document.getElementById('sliderUserName');
            loginLogoutButton = document.getElementById('loginLogoutButton');
            notificationButton = document.getElementById('notificationButton');
            notificationDropdown = document.getElementById('notificationDropdown');
            mobileMenuBtn = document.getElementById('mobileMenuBtn');
            mobileSliderMenu = document.getElementById('mobileSliderMenu');
            sliderBackdrop = document.getElementById('sliderBackdrop');
        }

        const DEFAULT_PROFILE_PIC_URL = 'https://i.pravatar.cc/300';
        function esc(str = "") {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }
        function setupSignInCardListener() {
            if (signInStatusCard) {
                signInStatusCard.addEventListener('click', () => {
                    window.location.href = 'login.html';
                });
            }
        }

        // DOM Elements specific to reffer.html
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const referCodeInput = document.getElementById('referCode');
        const referLinkInput = document.getElementById('referLink');
        const referrerForm = document.getElementById('referrerForm');
        const referrerCodeInput = document.getElementById('referrerCode');
        const submitReferrerBtn = document.getElementById('submitReferrerBtn');
        const formMessage = document.getElementById('formMessage');
        const refereePointsDisplay = document.getElementById('referee-points-display');
        const referrerPointsDisplay = document.getElementById('referrer-points-display');

        // State for the current user's referral code to prevent self-referral
        let currentUserReferralCode = null;

        // Function to generate a new 5-20 numeric referral code
        function generateReferralCode() {
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += Math.floor(Math.random() * 10);
            }
            return code;
        }

        /**
         * Fetches and displays referral points from the database settings.
         */
        async function fetchReferralPoints() {
            try {
                const pointsRef = ref(db, 'settings/referralPoints');
                const snapshot = await get(pointsRef);
                const points = snapshot.exists() ? snapshot.val() : { referrer: 10, referee: 10 };
                
                if (refereePointsDisplay) refereePointsDisplay.textContent = `${points.referee}`;
                if (referrerPointsDisplay) referrerPointsDisplay.textContent = `${points.referrer}`;

            } catch (error) {
                console.error("Failed to fetch referral points:", error);
                if (refereePointsDisplay) refereePointsDisplay.textContent = `লোড করতে ব্যর্থ`;
                if (referrerPointsDisplay) referrerPointsDisplay.textContent = `লোড করতে ব্যর্থ`;
            }
        }
        
        /**
         * Loads user data, handles referral code generation, and updates the UI.
         */
        async function loadUserDataAndReferral() {
            const user = auth.currentUser;
            if (!user) {
                referCodeInput.value = 'লগইন করুন';
                referLinkInput.value = 'লগইন করুন';
                currentUserReferralCode = null;
                return;
            }

            const userRef = child(ref(db), `users/${user.uid}`);
            try {
                const userSnap = await get(userRef);
                const userData = userSnap.val();

                if (userData && userData.referralCode) {
                    currentUserReferralCode = userData.referralCode;
                } else {
                    const newReferralCode = generateReferralCode();
                    const updates = {};
                    updates[`users/${user.uid}/referralCode`] = newReferralCode;
                    updates[`referralCodes/${newReferralCode}`] = user.uid;
                    await update(ref(db), updates);
                    currentUserReferralCode = newReferralCode;
                }

                referCodeInput.value = esc(currentUserReferralCode);
                referLinkInput.value = `${window.location.origin}/reffer.html?code=${esc(currentUserReferralCode)}`;
                
            } catch (error) {
                console.error("Error loading/creating referral code:", error);
                referCodeInput.value = 'ত্রুটি';
                referLinkInput.value = 'ত্রুটি';
            }
        }

        async function loadUserDataFromFirebase() {
            if (userPointsCard) userPointsCard.classList.add('hidden');
            if (signInStatusCard) signInStatusCard.classList.add('hidden');
            if (loadingStatusCard) loadingStatusCard.classList.remove('hidden');

            onAuthStateChanged(auth, async (user) => {
                let displayNameToShow = "ইউজার";
                if (user) {
                    const userRef = child(ref(db), `users/${user.uid}`);
                    const userSnap = await get(userRef);
                    const userData = userSnap.val();
                    
                    if (userData) {
                        if (userData.profilePictureUrl) {
                            if (headerProfileLogo) headerProfileLogo.src = userData.profilePictureUrl;
                            if (sliderProfilePic) sliderProfilePic.src = userData.profilePictureUrl;
                        } else {
                            if (headerProfileLogo) headerProfileLogo.src = DEFAULT_PROFILE_PIC_URL;
                            if (sliderProfilePic) sliderProfilePic.src = DEFAULT_PROFILE_PIC_URL;
                        }

                        if (userData.displayName) {
                            displayNameToShow = userData.displayName;
                        } else if (user.email) {
                            displayNameToShow = user.email;
                        }
                        
                        if (typeof userData.points !== 'undefined') {
                            if (userPointsDisplay) userPointsDisplay.textContent = `${esc(userData.points)} Points`;
                        } else {
                            if (userPointsDisplay) userPointsDisplay.textContent = `0 Points`;
                        }
                        if (userPointsCard) userPointsCard.classList.remove('hidden');
                    }
                    
                    if (loadingStatusCard) loadingStatusCard.classList.add('hidden');
                    if (signInStatusCard) signInStatusCard.classList.add('hidden');
                    if (welcomeMessage) welcomeMessage.textContent = `স্বাগতম, ${displayNameToShow}`;
                    if (sliderUserName) sliderUserName.textContent = `স্বাগতম, ${displayNameToShow}`;

                    if (loginLogoutButton) {
                        loginLogoutButton.textContent = 'লগআউট করুন';
                        loginLogoutButton.classList.remove('btn-login');
                        loginLogoutButton.classList.add('btn-logout');
                        loginLogoutButton.onclick = async () => {
                            await signOut(auth);
                            closeSliderMenu();
                        };
                    }
                    loadUserDataAndReferral();

                } else {
                    displayNameToShow = "অতিথি";
                    if (headerProfileLogo) headerProfileLogo.src = DEFAULT_PROFILE_PIC_URL;
                    if (sliderProfilePic) sliderProfilePic.src = DEFAULT_PROFILE_PIC_URL;
                    if (userPointsCard) userPointsCard.classList.add('hidden');
                    if (signInStatusCard) signInStatusCard.classList.remove('hidden');
                    if (signInStatusDisplay) signInStatusDisplay.textContent = `লগইন করুন`;
                    if (loadingStatusCard) loadingStatusCard.classList.add('hidden');
                    if (welcomeMessage) welcomeMessage.textContent = `স্বাগতম, ${displayNameToShow}`;
                    if (sliderUserName) sliderUserName.textContent = `স্বাগতম, ${displayNameToShow}`;
                    
                    if (loginLogoutButton) {
                        loginLogoutButton.textContent = 'লগইন করুন';
                        loginLogoutButton.classList.remove('btn-logout');
                        loginLogoutButton.classList.add('btn-login');
                        loginLogoutButton.onclick = () => {
                            window.location.href = 'login.html';
                        };
                    }
                    signInAnonymously(auth).catch((error) => console.error("Error signing in anonymously:", error));
                }
            });
        }
        
        async function loadNotifications(userId) {
            try {
                const snapshot = await get(child(ref(db), "notifications"));
                if (!snapshot.exists()) return [];
                const notificationsData = snapshot.val();
                const allNotificationData = [];
                for (const notificationId in notificationsData) {
                    const data = notificationsData[notificationId];
                    const isRead = data.readBy && userId ? data.readBy[userId] : false;
                    allNotificationData.push({ id: notificationId, ...data, read: isRead });
                }
                allNotificationData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                return allNotificationData;
            } catch (error) {
                console.error("নোটিফিকেশন লোড করতে সমস্যা:", error);
                return [];
            }
        }
        async function markNotificationAsRead(notificationId, userId) {
            try {
                await update(ref(db, `notifications/${notificationId}/readBy/${userId}`), true);
                loadAllNotificationsForUI();
            } catch (error) {
                console.error("নোটিফিকেশন পঠিত হিসাবে চিহ্নিত করতে সমস্যা:", error);
            }
        }
        async function loadAllNotificationsForUI() {
            let unreadCount = 0;
            onAuthStateChanged(auth, async (user) => {
                const currentUserId = user ? user.uid : null;
                const allNotifications = await loadNotifications(currentUserId);
                if (notificationList) notificationList.innerHTML = '';
                if (allNotifications.length === 0) {
                    if (notificationList) notificationList.innerHTML = `<p class="text-center text-gray-500 py-2">কোনো নোটিফিকেশন নেই।</p>`;
                } else {
                    allNotifications.forEach((notification) => {
                        if (!notification.read) unreadCount++;
                        const notificationItem = document.createElement('a');
                        notificationItem.href = notification.link || '#';
                        notificationItem.className = `block px-4 py-2 hover:bg-gray-100 border-b border-gray-100 last:border-b-0 ${notification.read ? 'opacity-70' : 'font-semibold'}`;
                        let timeAgoText = "এইমাত্র";
                        if (notification.timestamp) {
                            const date = new Date(notification.timestamp);
                            const now = new Date();
                            const diffMs = now - date;
                            const diffMinutes = Math.round(diffMs / (1000 * 60));
                            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
                            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
                            if (diffMinutes < 1) timeAgoText = "এইমাত্র";
                            else if (diffMinutes < 60) timeAgoText = `${diffMinutes} মিনিট আগে`;
                            else if (diffHours < 24) timeAgoText = `${diffHours} ঘন্টা আগে`;
                            else timeAgoText = `${diffDays} দিন আগে`;
                        }
                        notificationItem.innerHTML = `
                            <p class="text-sm text-gray-800">${esc(notification.title || "Untitled Notification")}</p>
                            ${notification.message ? `<p class="text-xs text-gray-500 mt-1">${esc(notification.message)}</p>` : ""}
                            <p class="text-xs text-gray-400 mt-1">${timeAgoText}</p>
                        `;
                        if (notificationList) notificationList.appendChild(notificationItem);
                        if (!notification.read && currentUserId) {
                            notificationItem.addEventListener('click', () => {
                                markNotificationAsRead(notification.id, currentUserId);
                            });
                        }
                    });
                }
                if (notificationCountDisplay) notificationCountDisplay.textContent = unreadCount.toString();
                if (newNotificationCount) newNotificationCount.textContent = `${unreadCount}টি নতুন`;
                if (unreadCount === 0 && allNotifications.length === 0) {
                    if (notificationList) notificationList.innerHTML = `<p class="text-center text-gray-500 py-2">কোনো নোটিফিকেশন নেই।</p>`;
                } else if (unreadCount === 0 && allNotifications.length > 0) {
                    if (newNotificationCount) newNotificationCount.textContent = `০টি নতুন`;
                }
            });
        }
        function closeSliderMenu() {
            if (mobileSliderMenu && sliderBackdrop) {
                mobileSliderMenu.classList.remove('active');
                sliderBackdrop.classList.remove('active');
                setTimeout(() => {
                    sliderBackdrop.classList.add('hidden');
                }, 350);
                document.body.style.overflow = '';
                mobileMenuBtn.setAttribute('aria-expanded', 'false');
            }
        }
        function setupMobileMenuListeners() {
            if (mobileMenuBtn && mobileSliderMenu && sliderBackdrop) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileSliderMenu.classList.add('active');
                    sliderBackdrop.classList.remove('hidden');
                    sliderBackdrop.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    mobileMenuBtn.setAttribute('aria-expanded', 'true');
                });
                sliderBackdrop.addEventListener('click', closeSliderMenu);
            }
        }
        function setupNotificationDropdownListeners() {
            if (notificationButton && notificationDropdown) {
                notificationButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    notificationDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (event) => {
                    if (!notificationDropdown.contains(event.target) && !notificationButton.contains(event.target)) {
                        notificationDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Function to copy text to clipboard securely (modern API)
        function copyTextToClipboard(text) {
            if (!navigator.clipboard) {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
            } else {
                navigator.clipboard.writeText(text).then(function() {
                    console.log('Async: Copying to clipboard was successful!');
                }, function(err) {
                    console.error('Async: Could not copy text: ', err);
                });
            }
        }

        copyCodeBtn.addEventListener('click', () => {
            const textToCopy = referCodeInput.value;
            if (['লোড হচ্ছে...', 'লগইন করুন', 'ত্রুটি', 'কোড নেই'].includes(textToCopy)) {
                return;
            }
            copyTextToClipboard(textToCopy);
            copyCodeBtn.innerHTML = '<i class="fas fa-check mr-2"></i> কপি হয়েছে';
            setTimeout(() => {
                copyCodeBtn.innerHTML = '<i class="fas fa-copy mr-2"></i> কোড কপি করুন';
            }, 2000);
        });

        copyLinkBtn.addEventListener('click', () => {
            const textToCopy = referLinkInput.value;
            if (['লোড হচ্ছে...', 'লগইন করুন', 'ত্রুটি', 'লিংক নেই'].includes(textToCopy)) {
                return;
            }
            copyTextToClipboard(textToCopy);
            copyLinkBtn.innerHTML = '<i class="fas fa-check mr-2"></i> কপি হয়েছে';
            setTimeout(() => {
                copyLinkBtn.innerHTML = '<i class="fas fa-link mr-2"></i> লিংক কপি করুন';
            }, 2000);
        });

        /**
         * Submits the referrer code and updates points for both users.
         * @param {string} code The referral code to submit.
         */
        async function submitReferrerCode(code) {
            const user = auth.currentUser;
            if (!user) {
                updateFormMessage('রেফার কোড সাবমিট করতে লগইন করুন।', 'error');
                return;
            }

            const userSnap = await get(child(ref(db), `users/${user.uid}`));
            const userData = userSnap.val();
            if (userData && userData.referrerCode) {
                updateFormMessage('আপনি ইতিমধ্যেই একটি রেফার কোড ব্যবহার করেছেন।', 'error');
                return;
            }

            if (code === currentUserReferralCode) {
                updateFormMessage('আপনি নিজের রেফার কোড ব্যবহার করতে পারবেন না।', 'error');
                return;
            }

            const referrerCodeRef = child(ref(db), `referralCodes/${code}`);
            const referrerSnap = await get(referrerCodeRef);
            const referrerUid = referrerSnap.val();

            if (referrerUid) {
                const pointsRef = ref(db, 'settings/referralPoints');
                const pointsSnap = await get(pointsRef);
                const referralPoints = pointsSnap.exists() ? pointsSnap.val() : { referrer: 10, referee: 10 };

                const userCurrentPoints = userData.points || 0;
                const referrerRef = child(ref(db), `users/${referrerUid}`);
                const referrerData = (await get(referrerRef)).val();
                const referrerCurrentPoints = referrerData.points || 0;

                const updates = {};
                updates[`users/${user.uid}/referrerCode`] = code;
                updates[`users/${user.uid}/points`] = userCurrentPoints + referralPoints.referee;
                
                updates[`users/${referrerUid}/points`] = referrerCurrentPoints + referralPoints.referrer;
                
                await update(ref(db), updates);
                
                updateFormMessage(`রেফার কোডটি সফলভাবে সাবমিট হয়েছে এবং আপনি ${referralPoints.referee} পয়েন্ট এবং রেফারকারী ${referralPoints.referrer} পয়েন্ট পেয়েছেন! ধন্যবাদ!`, 'success');
                referrerCodeInput.value = '';
                
                loadUserDataAndReferral();
            } else {
                updateFormMessage('এই রেফার কোডটি বিদ্যমান নেই।', 'error');
            }
        }
        
        function updateFormMessage(message, type) {
            formMessage.textContent = message;
            formMessage.classList.remove('text-green-600', 'text-red-600');
            if (type === 'success') {
                formMessage.classList.add('text-green-600');
            } else {
                formMessage.classList.add('text-red-600');
            }
        }

        referrerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = referrerCodeInput.value.trim();
            const pattern = /^[0-9]{5,20}$/;
            const submitBtnText = submitReferrerBtn.textContent;

            if (!pattern.test(code)) {
                updateFormMessage('সঠিক ফরম্যাটে কোড দিন।', 'error');
                return;
            }
            
            submitReferrerBtn.disabled = true;
            submitReferrerBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> সাবমিট হচ্ছে...`;
            submitReferrerBtn.classList.add('button-loading');

            try {
                await submitReferrerCode(code);
            } catch (error) {
                console.error("Submit error:", error);
                updateFormMessage('কোড সাবমিট করার সময় একটি ত্রুটি হয়েছে।', 'error');
            } finally {
                submitReferrerBtn.disabled = false;
                submitReferrerBtn.textContent = submitBtnText;
                submitReferrerBtn.classList.remove('button-loading');
            }
        });

        // Initial setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            loadHeaderTemplate();
            getHeaderElements();
            setupSignInCardListener();
            setupMobileMenuListeners();
            setupNotificationDropdownListeners();
            loadUserDataFromFirebase();
            loadAllNotificationsForUI();
            fetchReferralPoints();
        });
    </script>
</body>
</html>


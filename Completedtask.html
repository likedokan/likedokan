<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>আমার সম্পন্ন করা টাস্ক</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri&amp;display=swap" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            overflow-x: hidden;
        }
    .popup-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
      z-index: 10;
      min-width: 150px;
    }
    .popup-menu.active {
      display: block;
    }

    /* Skeleton Loading Styles for cards */
    .skeleton-card {
      background-color: #f3f4f6;
      overflow: hidden;
      position: relative;
    }
    .shimmer {
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #f3f4f6 8%, #e5e7eb 18%, #f3f4f6 33%);
      background-size: 800px 104px;
      position: absolute;
      top: 0;
      left: -800px;
      animation: shimmer 1.5s infinite linear;
    }
    @keyframes shimmer {
      0% { left: -800px; }
      100% { left: 800px; }
    }
    .skeleton-line {
      background-color: #e5e7eb;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    .skeleton-circle {
      background-color: #e5e7eb;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
    }
    #header-profile-logo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #007bff;
      object-fit: cover;
    }
    /* Styles for mobile slide-out menu */
    #mobileSliderMenu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background-color: #ffffff;
      box-shadow: -8px 0 15px rgba(0, 0, 0, 0.15), inset 4px 0 8px rgba(255, 255, 255, 0.6);
      z-index: 1000;
      transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      padding-top: 5rem;
      display: flex;
      flex-direction: column;
      border-top-left-radius: 1rem;
      border-bottom-left-radius: 1rem;
      backdrop-filter: saturate(180%) blur(12px);
      -webkit-backdrop-filter: saturate(180%) blur(12px);
    }
    #mobileSliderMenu.active {
      right: 0;
      box-shadow: -12px 0 25px rgba(0, 0, 0, 0.25), inset 4px 0 12px rgba(255, 255, 255, 0.7);
    }
    #sliderMenuContent {
      flex-grow: 1;
      padding: 1.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    #sliderMenuContent .menu-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.75rem;
      color: #4338ca;
      font-weight: 600;
      font-size: 1.125rem;
      border-radius: 0.75rem;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      text-decoration: none;
      box-shadow: 0 0 0 0 transparent;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    #sliderMenuContent .menu-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: #4338ca;
      border-top-right-radius: 0.75rem;
      border-bottom-right-radius: 0.75rem;
      transform: scaleY(0);
      transform-origin: center;
      transition: transform 0.3s ease;
      z-index: 1;
    }
    #sliderMenuContent .menu-item:hover::before,
    #sliderMenuContent .menu-item:focus-visible::before {
      transform: scaleY(1);
    }
    #sliderMenuContent .menu-item:hover {
      background-color: #4338ca;
      color: #e0e7ff;
      transform: translateX(6px);
      box-shadow: 0 8px 15px rgba(67, 56, 202, 0.3);
      z-index: 10;
      outline: none;
    }
    #sliderMenuContent .menu-item:focus-visible {
      outline: 2px solid #4338ca;
      outline-offset: 2px;
    }
    #sliderBackdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.45);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    #sliderBackdrop.active {
      opacity: 1;
      visibility: visible;
    }
    #notificationDropdown::before {
      content: '';
      position: absolute;
      top: -10px;
      right: 18px;
      border-width: 0 10px 10px 10px;
      border-color: transparent transparent white transparent;
      filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.05));
      z-index: 51;
    }
    #notificationDropdown::after {
      content: '';
      position: absolute;
      top: -11px;
      right: 343px;
      border-width: 0 10px 10px 10px;
      border-color: transparent transparent #e2e8f0 transparent;
      z-index: 50;
    }
    @media (max-width: 639px) {
      #notificationDropdown::before,
      #notificationDropdown::after {
        right: 25px;
      }
    }
    .spinner {
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4f46e5;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .btn-login {
      background-color: #22c55e;
      color: white;
    }
    .btn-login:hover {
      background-color: #16a34a;
    }
    .btn-login:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4ade80, 0 0 0 4px rgba(34, 197, 94, 0.5);
    }
    .btn-logout {
      background-color: #ef4444;
      color: white;
    }
    .btn-logout:hover {
      background-color: #dc2626;
    }
    .btn-logout:focus {
      outline: none;
      box-shadow: 0 0 0 2px #f87171, 0 0 0 4px rgba(239, 68, 68, 0.5);
    }
    /* Updated filter button styles */
    #filter-button-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    #filter-button {
      background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
      --tw-gradient-from: #4f46e5;
      --tw-gradient-to: #8b5cf6;
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px; /* Full rounded corners */
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      width: 100%;
    }
    
    #filter-button:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 15px 30px rgba(79, 70, 229, 0.4);
    }
    
    /* Updated popup menu styles */
    #popup-options {
      border-radius: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-top: 0.75rem;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    .filter-option {
      transition: background-color 0.2s ease, transform 0.1s ease;
      color: #334155;
    }
    .filter-option:hover {
      background-color: rgba(79, 70, 229, 0.1);
      transform: translateX(6px);
      color: #4f46e5;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-cyan-100 to-blue-200 min-h-screen">
  <!-- Header Template -->
  <template id="header-template">
    <header class="bg-white shadow-xl sticky top-0 z-50 border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-3 sm:space-x-4">
          <img alt="প্রোফাইল ছবি"
               class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-indigo-500 shadow-md"
               loading="lazy"
               src="https://i.pravatar.cc/300?img=1"
               id="header-profile-logo"/>
          <div class="hidden sm:block">
            <p id="welcomeMessage" class="text-gray-700 font-semibold text-base sm:text-lg leading-tight select-none">Your Name</p>
            <p class="text-gray-500 text-xs sm:text-sm select-none">আপনার প্রোফাইল</p>
          </div>
          <h1 class="text-2 sm:text-3xl font-extrabold text-indigo-600 tracking-wide select-none ml-4 sm:ml-6">
            <span>Order</span>
          </h1>
        </div>

        <div class="flex items-center space-x-3 sm:space-x-4">
          <div class="flex items-center space-x-3">
            <div id="userPointsCard" aria-label="আপনার পয়েন্ট"
                 class="flex items-center bg-indigo-50 text-indigo-700 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90 hidden">
              <i class="fas fa-coins mr-1 text-yellow-400 text-sm"></i>
              <span id="userPointsDisplay">0 Points</span>
            </div>

            <div id="signInStatusCard" aria-label="সাইন-ইন স্ট্যাটাস"
                 class="flex items-center bg-red-50 text-red-700 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90 hidden cursor-pointer">
              <i class="fas fa-user-circle mr-1 text-red-500 text-sm"></i>
              <span id="signInStatusDisplay">লগইন করুন</span>
            </div>

            <div id="loadingStatusCard" class="flex items-center bg-gray-100 text-gray-600 font-semibold px-2 py-1 rounded-full shadow select-none text-xs scale-90">
              <div class="spinner mr-2"></div>
              <span>লোড হচ্ছে...</span>
            </div>
          </div>

          <button id="notificationButton" aria-label="নোটিফিকেশন"
                  class="relative text-indigo-600 hover:text-indigo-800 transition focus:outline-none">
            <i class="fas fa-bell text-lg sm:text-xl"></i>
            <span class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-600 text-white text-xs rounded-full px-1 sm:px-1.5 shadow-lg" id="notificationCountDisplay">0</span>
          </button>

          <div id="notificationDropdown" class="absolute top-16 right-4 sm:right-6 md:right-10 bg-white border border-gray-200 rounded-lg shadow-lg w-64 md:w-80 z-50 hidden">
            <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
              <h3 class="font-semibold text-gray-800">নোটিফিকেশনস</h3>
              <span class="text-xs text-gray-500" id="newNotificationCount">০টি নতুন</span>
            </div>
            <div class="py-2 max-h-60 overflow-y-auto" id="notificationList">
            </div>
            <div class="px-4 py-3 border-t border-gray-200 text-center">
              <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">সকল নোটিফিকেশন দেখুন</a>
            </div>
          </div>
          <button id="mobileMenuBtn" aria-label="মেনু"
                  aria-controls="mobileSliderMenu"
                  aria-expanded="false"
                  class="md:hidden text-indigo-600 hover:text-indigo-800 text-xl sm:text-2xl focus:outline-none">
            <i class="fas fa-bars"></i>
          </button>

          <nav aria-label="প্রধান নেভিগেশন"
               class="hidden md:flex items-center space-x-6 lg:space-x-8 text-indigo-600 font-semibold select-none text-base"
               role="navigation">
            <a class="hover:text-indigo-800 transition" href="dashboard.html">ড্যাশবোর্ড</a>
            <a class="hover:text-indigo-800 transition" href="mytasklist.html">টাস্ক</a>
            <a class="hover:text-indigo-800 transition" href="leaderboard.html">লিডারবোর্ড</a>
            <a class="hover:text-indigo-800 transition" href="order.html">অর্ডার</a>
          </nav>
        </div>
      </div>

      <div id="mobileSliderMenu" role="menu" aria-label="মোবাইল স্লাইডার মেনু">
        <div class="flex items-center space-x-3 p-4 border-b border-gray-200 mb-4">
          <img alt="স্লাইডার প্রোফাইল ছবি"
               class="w-16 h-16 rounded-full border-2 border-indigo-500 shadow-md"
               loading="lazy"
               src="https://i.pravatar.cc/300?img=1"
               id="slider-profile-pic"/>
          <div>
            <p id="sliderUserName" class="text-gray-700 font-semibold text-lg leading-tight">Your Name</p>
            <p class="text-gray-500 text-sm">আপনার প্রোফাইল</p>
          </div>
        </div>
        <div id="sliderMenuContent" role="none">
          <a class="menu-item" href="dashboard.html" role="menuitem" tabindex="0">ড্যাশবোর্ড</a>
          <a class="menu-item" href="mytasklist.html" role="menuitem" tabindex="0">আমার টাস্ক</a>
          <a class="menu-item" href="completedtask.html" role="menuitem" tabindex="0">সম্পূর্ণ করা টাস্ক</a>
          <a class="menu-item" href="order.html" role="menuitem" tabindex="0">অর্ডার করুন</a>
          <a class="menu-item" href="reffer.html" role="menuitem" tabindex="0">রেফার করুন</a>
          <a class="menu-item" href="leaderboard.html" role="menuitem" tabindex="0">লিডারবোর্ড</a>
        </div>
        <div class="p-4 mt-auto border-t border-gray-200">
          <button id="loginLogoutButton" class="w-full py-2 px-4 rounded-md font-semibold transition-colors duration-200
                                        focus:outline-none focus:ring-2 focus:ring-offset-2">
            লগইন করুন
          </button>
        </div>
      </div>
      <div id="sliderBackdrop" class="hidden" tabindex="-1" aria-hidden="true"></div>
    </header>
  </template>

  <!-- Main Content from Completedtask.html -->
  <main class="max-w-5xl mx-auto px-4 p-6">
    <div class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-900 mb-2">আমার সম্পন্ন করা টাস্ক</h1>
      <p class="text-blue-800 text-base sm:text-lg">আপনার সম্পন্ন করা টাস্ক ও তাদের স্ট্যাটাস দেখতে পারবেন</p>
    </div>

    <div class="flex justify-center items-center mb-6">
      <div id="filter-button-container" class="relative w-full sm:w-auto mx-auto sm:mx-0">
        <button id="filter-button" type="button" class="inline-flex justify-center items-center w-full sm:w-60 rounded-full border border-gray-300 shadow-xl px-6 py-3 bg-gradient-to-br from-indigo-500 to-purple-600 text-base font-medium text-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500 transition-all duration-300 ease-in-out hover:scale-105 hover:shadow-2xl">
          স্ট্যাটাস ফিল্টার
          <svg class="-mr-1 ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>

        <div id="popup-options" class="popup-menu w-full sm:w-60 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-sm shadow-2xl">
          <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="filter-button">
            <a href="#" class="filter-option block px-4 py-2 text-base text-gray-700 hover:bg-indigo-100/70 hover:text-indigo-800" data-status="all">সব</a>
            <a href="#" class="filter-option block px-4 py-2 text-base text-gray-700 hover:bg-indigo-100/70 hover:text-indigo-800" data-status="pending"><i class="fas fa-hourglass-half mr-2 text-yellow-600"></i>Pending</a>
            <a href="#" class="filter-option block px-4 py-2 text-base text-gray-700 hover:bg-indigo-100/70 hover:text-indigo-800" data-status="approved"><i class="fas fa-check-circle mr-2 text-green-600"></i>Approved</a>
            <a href="#" class="filter-option block px-4 py-2 text-base text-gray-700 hover:bg-indigo-100/70 hover:text-indigo-800" data-status="rejected"><i class="fas fa-times-circle mr-2 text-red-600"></i>Rejected</a>
          </div>
        </div>
      </div>
    </div>
    
    <p id="loading-message" class="text-center text-lg text-blue-900">Loading tasks...</p>
    <section id="tasks-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
  </main>

  <!-- Merged and updated JavaScript -->
  <script type="module">
    // Import necessary Firebase modules from a specific version
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, child, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Your given Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAC4h55aA0Zz--V5ejyndzR5WC_-9rAPio",
      authDomain: "subscribe-bot-6f9b2.firebaseapp.com",
      databaseURL: "https://subscribe-bot-6f9b2-default-rtdb.firebaseio.com",
      projectId: "subscribe-bot-6f9b2",
      storageBucket: "subscribe-bot-6f9b2.firebasestorage.app",
      messagingSenderId: "141787931031",
      appId: "1:141787931031:web:2108a3e930f5ce4fbc64d2",
      measurementId: "G-HSDKCJB14Y"
    };

    // Initialize Firebase and Realtime Database
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let userId;

    // Utility function for escaping HTML
    function esc(str = "") {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    // --- Header Template Functions ---
    function loadHeaderTemplate() {
      const template = document.getElementById('header-template');
      if (template) {
        const clone = document.importNode(template.content, true);
        document.body.prepend(clone);
      } else {
        console.error("Header template not found!");
      }
    }

    let headerProfileLogo, userPointsCard, userPointsDisplay, signInStatusCard, signInStatusDisplay,
        loadingStatusCard, notificationCountDisplay, newNotificationCount, notificationList,
        welcomeMessage, sliderProfilePic, sliderUserName, loginLogoutButton, notificationButton,
        notificationDropdown, mobileMenuBtn, mobileSliderMenu, sliderBackdrop;

    function getHeaderElements() {
      headerProfileLogo = document.getElementById('header-profile-logo');
      userPointsCard = document.getElementById('userPointsCard');
      userPointsDisplay = document.getElementById('userPointsDisplay');
      signInStatusCard = document.getElementById('signInStatusCard');
      signInStatusDisplay = document.getElementById('signInStatusDisplay');
      loadingStatusCard = document.getElementById('loadingStatusCard');
      notificationCountDisplay = document.getElementById('notificationCountDisplay');
      newNotificationCount = document.getElementById('newNotificationCount');
      notificationList = document.getElementById('notificationList');
      welcomeMessage = document.getElementById('welcomeMessage');
      sliderProfilePic = document.getElementById('slider-profile-pic');
      sliderUserName = document.getElementById('slider-user-name');
      loginLogoutButton = document.getElementById('loginLogoutButton');
      notificationButton = document.getElementById('notificationButton');
      notificationDropdown = document.getElementById('notificationDropdown');
      mobileMenuBtn = document.getElementById('mobileMenuBtn');
      mobileSliderMenu = document.getElementById('mobileSliderMenu');
      sliderBackdrop = document.getElementById('sliderBackdrop');
    }

    const DEFAULT_PROFILE_PIC_URL = 'https://raw.githubusercontent.com/Tech-Jobayer/Website/blob/main/data/images.png';

    function setupSignInCardListener() {
      if (signInStatusCard) {
        signInStatusCard.addEventListener('click', () => {
          // You can define a login action here if needed
          alert('লগইন পেজে রিডাইরেক্ট করা হচ্ছে...');
        });
      }
    }

    async function loadUserDataFromFirebase(user) {
        let displayNameToShow = "ইউজার";
        if (userPointsCard) userPointsCard.classList.add('hidden');
        if (signInStatusCard) signInStatusCard.classList.add('hidden');
        if (loadingStatusCard) loadingStatusCard.classList.remove('hidden');

        if (user) {
            try {
                const userRef = child(ref(db), `users/${user.uid}`);
                const userSnap = await get(userRef);
                const userData = userSnap.val() || {};

                if (userData.profilePictureUrl) {
                    if (headerProfileLogo) headerProfileLogo.src = userData.profilePictureUrl;
                    if (sliderProfilePic) sliderProfilePic.src = userData.profilePictureUrl;
                } else {
                    if (headerProfileLogo) headerProfileLogo.src = DEFAULT_PROFILE_PIC_URL;
                    if (sliderProfilePic) sliderProfilePic.src = DEFAULT_PROFILE_PIC_URL;
                }
                
                if (userData.name) {
                    displayNameToShow = userData.name;
                } else if (user.email) {
                    displayNameToShow = user.email;
                }
                
                if (typeof userData.points !== 'undefined') {
                    if (userPointsDisplay) userPointsDisplay.textContent = `${esc(userData.points)} Points`;
                } else {
                    if (userPointsDisplay) userPointsDisplay.textContent = `0 Points`;
                }

                if (userPointsCard) userPointsCard.classList.remove('hidden');
                if (loadingStatusCard) loadingStatusCard.classList.add('hidden');
                if (welcomeMessage) welcomeMessage.textContent = ` ${displayNameToShow}`;
                if (sliderUserName) sliderUserName.textContent = ` ${displayNameToShow}`;

                if (loginLogoutButton) {
                    loginLogoutButton.textContent = 'লগআউট করুন';
                    loginLogoutButton.classList.remove('btn-login');
                    loginLogoutButton.classList.add('btn-logout');
                    loginLogoutButton.onclick = async () => {
                        await signOut(auth);
                        // Reload the page or update UI after logout
                        window.location.reload(); 
                    };
                }
            } catch (error) {
                console.error("Error loading user data from Realtime Database:", error);
                if (welcomeMessage) welcomeMessage.textContent = `Your Name`;
                if (sliderUserName) sliderUserName.textContent = `Your Name`;
                if (loadingStatusCard) loadingStatusCard.classList.add('hidden');
            }
        } else {
            if (headerProfileLogo) headerProfileLogo.src = DEFAULT_PROFILE_PIC_URL;
            if (sliderProfilePic) sliderProfilePic.src = DEFAULT_PROFILE_PIC_URL;
            if (signInStatusDisplay) signInStatusDisplay.textContent = `লগইন করুন`;
            if (signInStatusCard) signInStatusCard.classList.remove('hidden');
            if (loadingStatusCard) loadingStatusCard.classList.add('hidden');
            if (welcomeMessage) welcomeMessage.textContent = `Your Name`;
            if (sliderUserName) sliderUserName.textContent = `Your Name`;
            if (loginLogoutButton) {
                loginLogoutButton.textContent = 'লগইন করুন';
                loginLogoutButton.classList.remove('btn-logout');
                loginLogoutButton.classList.add('btn-login');
                loginLogoutButton.onclick = () => { /* Implement login action here */ };
            }
        }
    }

    async function loadNotifications(userId) {
      try {
        const snapshot = await get(child(ref(db), "notifications"));
        if (!snapshot.exists()) return [];
        const notificationsData = snapshot.val();
        const allNotificationData = [];
        for (const notificationId in notificationsData) {
          const data = notificationsData[notificationId];
          const isRead = data.readBy && userId ? data.readBy[userId] : false;
          allNotificationData.push({ id: notificationId, ...data, read: isRead });
        }
        allNotificationData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        return allNotificationData;
      } catch (error) {
        console.error("Error loading notifications from Realtime Database:", error);
        return [];
      }
    }

    async function markNotificationAsRead(notificationId, userId) {
      try {
        await update(ref(db, `notifications/${notificationId}/readBy/${userId}`), true);
        loadAllNotificationsForUI();
      } catch (error) {
        console.error("Error marking notification as read:", error);
      }
    }

    async function loadAllNotificationsForUI() {
      let unreadCount = 0;
      const user = auth.currentUser;
      const currentUserId = user ? user.uid : null;
      const allNotifications = await loadNotifications(currentUserId);
      if (notificationList) notificationList.innerHTML = '';
      if (allNotifications.length === 0) {
        if (notificationList) notificationList.innerHTML = `<p class="text-center text-gray-500 py-2">কোনো নোটিফিকেশন নেই।</p>`;
      } else {
        allNotifications.forEach((notification) => {
          if (!notification.read) unreadCount++;
          const notificationItem = document.createElement('a');
          notificationItem.href = notification.link || '#';
          notificationItem.className = `block px-4 py-2 hover:bg-gray-100 border-b border-gray-100 last:border-b-0 ${notification.read ? 'opacity-70' : 'font-semibold'}`;
          let timeAgoText = "এইমাত্র";
          if (notification.timestamp) {
            const date = new Date(notification.timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.round(diffMs / (1000 * 60));
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
            if (diffMinutes < 1) timeAgoText = "এইমাত্র";
            else if (diffMinutes < 60) timeAgoText = `${diffMinutes} মিনিট আগে`;
            else if (diffHours < 24) timeAgoText = `${diffHours} ঘন্টা আগে`;
            else timeAgoText = `${diffDays} দিন আগে`;
          }
          notificationItem.innerHTML = `
            <p class="text-sm text-gray-800">${esc(notification.title || "Untitled Notification")}</p>
            ${notification.message ? `<p class="text-xs text-gray-500 mt-1">${esc(notification.message)}</p>` : ""}
            <p class="text-xs text-gray-400 mt-1">${timeAgoText}</p>
          `;
          if (notificationList) notificationList.appendChild(notificationItem);
          if (!notification.read && currentUserId) {
            notificationItem.addEventListener('click', () => {
              markNotificationAsRead(notification.id, currentUserId);
            });
          }
        });
      }
      if (notificationCountDisplay) notificationCountDisplay.textContent = unreadCount.toString();
      if (newNotificationCount) newNotificationCount.textContent = `${unreadCount}টি নতুন`;
      if (unreadCount === 0 && allNotifications.length === 0) {
        if (notificationList) notificationList.innerHTML = `<p class="text-center text-gray-500 py-2">কোনো নোটিফিকেশন নেই।</p>`;
      } else if (unreadCount === 0 && allNotifications.length > 0) {
        if (newNotificationCount) newNotificationCount.textContent = `০টি নতুন`;
      }
    }

    // --- Mobile Slider Menu Logic ---
    let touchStartX = 0, touchCurrentX = 0, isSwiping = false;
    function closeSliderMenu() {
      if (mobileSliderMenu && sliderBackdrop) {
        mobileSliderMenu.classList.remove('active');
        sliderBackdrop.classList.remove('active');
        setTimeout(() => {
          sliderBackdrop.classList.add('hidden');
        }, 350);
        document.body.style.overflow = '';
        if (mobileMenuBtn) mobileMenuBtn.setAttribute('aria-expanded', 'false');
      }
    }
    function setupMobileMenuListeners() {
      if (mobileMenuBtn && mobileSliderMenu && sliderBackdrop) {
        mobileMenuBtn.addEventListener('click', () => {
          mobileSliderMenu.classList.add('active');
          sliderBackdrop.classList.remove('hidden');
          sliderBackdrop.classList.add('active');
          document.body.style.overflow = 'hidden';
          mobileMenuBtn.setAttribute('aria-expanded', 'true');
        });
        sliderBackdrop.addEventListener('click', closeSliderMenu);
        mobileSliderMenu.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            isSwiping = true;
            mobileSliderMenu.style.transition = 'none';
          }
        });
        mobileSliderMenu.addEventListener('touchmove', (e) => {
          if (!isSwiping) return;
          touchCurrentX = e.touches[0].clientX;
          const diffX = touchStartX - touchCurrentX;
          if (diffX > 0) {
            mobileSliderMenu.style.right = `${-diffX}px`;
            const opacity = 1 - (diffX / mobileSliderMenu.offsetWidth);
            sliderBackdrop.style.opacity = Math.max(0, opacity);
          }
        });
        mobileSliderMenu.addEventListener('touchend', () => {
          if (!isSwiping) return;
          const diffX = touchStartX - touchCurrentX;
          mobileSliderMenu.style.transition = 'right 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
          if (diffX > mobileSliderMenu.offsetWidth / 3) {
            closeSliderMenu();
          } else {
            mobileSliderMenu.style.right = '0';
            sliderBackdrop.style.opacity = '1';
          }
          isSwiping = false;
          touchStartX = 0;
          touchCurrentX = 0;
        });
      }
    }
    function setupNotificationDropdownListeners() {
      if (notificationButton && notificationDropdown) {
        notificationButton.addEventListener('click', (event) => {
          event.stopPropagation();
          notificationDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
          if (!notificationDropdown.contains(event.target) && !notificationButton.contains(event.target)) {
            notificationDropdown.classList.add('hidden');
          }
        });
      }
    }

    // --- Completedtask.html Functions ---
    /**
     * Renders the tasks dynamically from the provided data.
     * @param {Array<Object>} tasks - An array of task objects.
     */
    function renderTasks(tasks) {
      const tasksContainer = document.getElementById('tasks-container');
      tasksContainer.innerHTML = ''; // Clear existing tasks
      if (tasks.length === 0) {
        tasksContainer.innerHTML = `<p class="text-center text-lg text-gray-600">কোনো টাস্ক পাওয়া যায়নি।</p>`;
      } else {
        tasks.forEach(task => {
          const statusText = task.status;
          const statusColor = statusText === 'approved' ? 'bg-green-100 text-green-800' :
                              statusText === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800';
          const statusIcon = statusText === 'approved' ? 'fas fa-check-circle' :
                              statusText === 'pending' ? 'fas fa-hourglass-half' :
                              'fas fa-times-circle';
          
          // Format timestamp to a readable date
          const date = task.timestamp ? new Date(task.timestamp).toLocaleDateString('bn-BD') : 'N/A';
          
          const article = document.createElement('article');
          article.className = 'bg-white rounded-xl shadow-md p-6 task-article flex flex-col justify-between';
          article.setAttribute('data-status', statusText);
          
          let pointsHtml = '';
          if (statusText === 'approved' && task.points) {
            pointsHtml = `
              <span class="flex-shrink-0 flex items-center text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                <i class="fas fa-coins mr-1"></i> +${esc(task.points)}
              </span>
            `;
          }

          let rejectionReasonHtml = '';
          // Check for rejection reason only if status is rejected and the reason is not empty
          if (statusText === 'rejected' && task.rejectReason && task.rejectReason.trim() !== '') {
            rejectionReasonHtml = `
              <p class="text-sm text-red-600 mt-2">
                <i class="fas fa-exclamation-triangle mr-1"></i> <strong>কারণ:</strong> ${esc(task.rejectReason)}
              </p>
            `;
          }

          article.innerHTML = `
            <div>
              <h2 class="font-bold text-lg text-blue-900 mb-2">${esc(task.title || "Untitled Task")}</h2>
              ${task.ownerName ? `
              <p class="flex items-center text-gray-500 text-xs mt-1">
                <i class="fas fa-upload mr-2"></i> আপলোড করেছেন: ${esc(task.ownerName)}
              </p>
              ` : ''}
              ${rejectionReasonHtml}
            </div>
            <div class="flex items-center justify-between mt-4">
              <div class="flex items-center space-x-2">
                <span class="status-span flex items-center text-xs font-semibold px-3 py-1 rounded-full ${statusColor}">
                  <i class="${statusIcon} mr-2"></i> ${esc(statusText.charAt(0).toUpperCase() + statusText.slice(1))}
                </span>
                ${pointsHtml}
              </div>
              <p class="text-gray-500 text-xs text-right flex items-center">
                <i class="fas fa-calendar-alt mr-1"></i> ${esc(date)}
              </p>
            </div>
          `;
          tasksContainer.appendChild(article);
        });
      }
    }

    /**
     * Fetches the display name of a user from the 'users' node.
     * @param {string} ownerId The user ID of the task owner.
     * @returns {Promise<string>} The display name of the user or 'Unknown User'.
     */
    async function fetchTaskOwnerName(ownerId) {
        if (!ownerId) return 'Unknown User';
        try {
            const ownerRef = ref(db, `users/${ownerId}`);
            const ownerSnap = await get(ownerRef);
            return ownerSnap.exists() ? ownerSnap.val().name || 'Unknown User' : 'Unknown User';
        } catch (error) {
            console.error("Error fetching task owner's name:", error);
            return 'Unknown User';
        }
    }

    /**
     * Fetches tasks from Firebase Realtime Database and listens for real-time updates.
     */
    async function fetchTasks() {
      const tasksContainer = document.getElementById('tasks-container');
      const loadingMessage = document.getElementById('loading-message');
      
      if (!userId) {
        loadingMessage.textContent = 'User authentication failed. Please log in.';
        return;
      }
      
      loadingMessage.style.display = 'block';

      try {
        // Fetch all submissions for the current user
        const submissionsRef = ref(db, `submissions/${userId}`);
        const tasksRef = ref(db, 'tasks');
        
        onValue(submissionsRef, async (submissionSnapshot) => {
          loadingMessage.style.display = 'none';
          if (submissionSnapshot.exists()) {
            const submissionsData = submissionSnapshot.val();
            let allTasks = [];
            
            // Loop through each task ID that has a submission from the user
            for (const taskId in submissionsData) {
              const userSubmissionsForTask = submissionsData[taskId];
              
              // Loop through each submission ID for that task
              for (const submissionId in userSubmissionsForTask) {
                const submission = userSubmissionsForTask[submissionId];
                
                // Fetch the main task details to get the title and ownerId
                const taskSnap = await get(child(tasksRef, taskId));
                const taskData = taskSnap.val();
                
                // Fetch the name of the person who uploaded the task
                const ownerName = taskData ? await fetchTaskOwnerName(taskData.ownerId) : 'Unknown User';

                // Combine submission and task data
                const combinedTask = {
                  ...submission,
                  title: taskData ? taskData.title : 'Deleted Task',
                  taskId: taskId,
                  submissionId: submissionId,
                  ownerName: ownerName
                };
                allTasks.push(combinedTask);
              }
            }
            
            // Sort by timestamp, newest first
            allTasks.sort((a, b) => b.timestamp - a.timestamp);
            renderTasks(allTasks);
          } else {
            renderTasks([]);
          }
        });
      } catch (error) {
        console.error("Error fetching tasks:", error);
        loadingMessage.textContent = 'Error fetching tasks.';
      }
    }

    // Merged DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', () => {
      // Header initialization
      loadHeaderTemplate();
      getHeaderElements();
      setupSignInCardListener();
      setupMobileMenuListeners();
      setupNotificationDropdownListeners();

      // Main auth listener for both header and main content
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          loadUserDataFromFirebase(user);
          loadAllNotificationsForUI();
          fetchTasks(); // Fetch tasks after user is authenticated
        } else {
          userId = null;
          console.log("User signed out.");
          loadUserDataFromFirebase(null);
          if (document.getElementById('loading-message')) {
            document.getElementById('loading-message').textContent = 'Please log in to view tasks.';
          }
          if (document.getElementById('tasks-container')) {
            document.getElementById('tasks-container').innerHTML = '';
          }
        }
      });

      // Filter button logic from Completedtask.html
      const filterButton = document.getElementById('filter-button');
      const popupOptions = document.getElementById('popup-options');
      const tasksContainer = document.getElementById('tasks-container');
      const filterButtonContainer = document.getElementById('filter-button-container');

      if (filterButton && popupOptions) {
        filterButton.addEventListener('click', (e) => {
          e.stopPropagation();
          popupOptions.classList.toggle('active');
        });
        window.addEventListener('click', (e) => {
          if (!filterButtonContainer.contains(e.target)) {
            popupOptions.classList.remove('active');
          }
        });
      }

      if (popupOptions && tasksContainer) {
        popupOptions.addEventListener('click', (e) => {
          if (e.target.classList.contains('filter-option')) {
            e.preventDefault();
            const option = e.target;
            const filterStatus = option.getAttribute('data-status');
            
            // Update the button text without adding a new span
            filterButton.innerHTML = `${option.textContent.trim()} টাস্ক <svg class="-mr-1 ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;

            const taskArticles = tasksContainer.querySelectorAll('.task-article');
            taskArticles.forEach(article => {
              const status = article.getAttribute('data-status');
              if (filterStatus === 'all' || status === filterStatus) {
                article.style.display = 'block';
              } else {
                article.style.display = 'none';
              }
            });

            popupOptions.classList.remove('active');
          }
        });
      }
    });
  </script>
</body>
</html>

